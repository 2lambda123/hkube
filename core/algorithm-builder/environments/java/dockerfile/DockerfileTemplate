FROM maven
LABEL maintainer="hkube.dev@gmail.com"
ENV PACKAGES_REGISTRY_USER ${PACKAGES_REGISTRY_USER}
ENV PACKAGES_TOKEN ${PACKAGES_TOKEN}
COPY  ./dockerfile/cpy-settings ./algorithm_unique_folder/src/main/resources/settings.xml* /root/.m2/
COPY ./jars/* /hkube/algorithm-runner/
COPY ./debs /hkube/algorithm-runner/
COPY algorithm_unique_folder/ /hkube/algorithm-runner/algorithm_unique_folder/
COPY ./runJava.sh /hkube/algorithm-runner/
WORKDIR /hkube/algorithm-runner
RUN mvn -q dependency:get -Dartifact=io.hkube:wrapper:${javaWrapperVersion}:jar:wide -DremoteRepositories=https://oss.sonatype.org/content/repositories/snapshots -Ddest=./wrapper.jar
RUN mvn   -q org.apache.maven.plugins:maven-install-plugin:3.0.0-M1:install-file  -Dfile=./java-algo-parent.xml -DgroupId=io.hkube -DartifactId=java-algo-parent -Dversion=${javaWrapperVersion} -Dpackaging=pom
WORKDIR /hkube/algorithm-runner/algorithm_unique_folder/
RUN mvn -q  package -DremoteRepositories=${packagesRegistry}
FROM ${baseImage} 
RUN mkdir -p /hkube/algorithm-runner
COPY --from=0 /hkube/algorithm-runner/ /hkube/algorithm-runner
WORKDIR /hkube/algorithm-runner
RUN mkdir -p /hkube-logs
RUN  dpkg -i libpgm-5.2-0_5.2.122~dfsg-2_amd64.deb && dpkg -i libnorm1_1.5r6+dfsg1-6_amd64.deb && dpkg -i libsodium23_1.0.16-2_amd64.deb && dpkg -i libzmq5_4.2.5-1ubuntu0.2_amd64.deb && dpkg -i libzmq-jni_3.1.0-10_amd64.deb && dpkg -i libzmq-java_3.1.0-10_amd64.deb
CMD ["/bin/sh", "-c", "./runJava.sh"]